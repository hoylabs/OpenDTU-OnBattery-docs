# Dynamic Power Limiter (DPL)

## Screenshot

![DPL Settings](../../assets/images/screenshots/dpl.png)

## Settings/Parameters

!!!warning "Dynamic UI"
    Some settings are not visible/accessible, depending on your setup of
    other features, e.g., without a battery interface enabled, SoC thresholds
    cannot be configured.

### General

#### Enable :material-toggle-switch:{title="Switch"}

Enables or disables the DPL.

!!!note "Disabling"
    When disabling the DPL using this switch, the inverters previously governed
    by the DPL are shut down. Once they are shut down, the DPL does not send
    commands to those inverters anymore.

#### Govern Inverter :material-toggle-switch:{title="Switch"}

Select the inverters, out of all inverters registered to OpenDTU-OnBattery,
that shall receive limit updates calculated by the DPL to match the target grid
consumption.

#### Verbose Logging :material-toggle-switch:{title="Switch"}

Enable to log more information regarding the calculation of the power limits to
the (serial or web) console. Definitely enable this and read the logs if the
DPL does not behave as expected, and share the output in case you seek help.

#### Target Grid Consumption :material-form-textbox:{title="Textbox"}

The DPL calculates the inverter limits such that the power meter reads this
amount of power. To implement a zero export policy, set this value to zero. If this
value is negative, the power limits will be calculated such that the configured
power is fed into the grid.

!!!warning "Over- and Undershooting"
    The inverters **will** over- and undershoot, especially when significant
    loads (water heaters, electric stoves, etc.) are switched on or off. In
    particular this means that energy will be fed into the grid for some time
    (how long depends on the setup) when loads are switched off.

#### Base Load :material-form-textbox:{title="Textbox"}

In case the power meter reading is unavailable (transient error) or in setups
without a power meter configured, this value is assumed as the power meter
reading. Choose this value such that it is close to but slightly smaller than
your household's base load, i.e., the amount of power that is expected to be
consumed in any case.

In case a power meter is configured, you may set this value to zero if you want
the DPL to effectively disable all governed inverters once the power meter
fails.

#### Hysteresis :material-form-textbox:{title="Textbox"}

No limit update will be sent to an inverter if the difference between the
calculated new limit and the current limit, as reported by the inverter, is
less or equal to this hysteresis value.

#### Maximum Total Output :material-form-textbox:{title="Textbox"}

!!!danger "Cabling limits"
    This is **NOT** a safety feature. Do not rely on OpenDTU-OnBattery to
    protect your cables from excessive currents. Make sure that the AC cabling
    is able to safely handle the **rated** output of **all** inverters combined
    and enforce protection using respective fuses. The rated output is the
    inverter's AC power output while its limit is at 100% and all inputs
    deliver such that the inverter does output 100% of its rating, e.g., 2000W
    for an HMS-2000. Unreachable inverters can still produce an unknown amount
    of power. The maximum total output is available as allowance for all
    **other** inverters. Hence, the reachable inverters can potentially produce
    as much power as the maximum total output allows, while the unreachable
    inverter(s) produce **additional** power.

The DPL will set limits such that at most this amount of power is generated by
the inverters in total.

### Individual Inverter Settings

Settings regarding a single particular inverter are grouped in one such card
per governed inverter.

#### Power Meter Reading Includes Inverter Output :material-toggle-switch:{title="Switch"}

Enable this option if the power meter reading is reduced by the inverter's
output when the inverter produces AC power. This is typically true, as the
metering happens between the grid and the inverter.

#### Inverter Is Powered By Solar Modules :material-toggle-switch:{title="Switch"}

Enable if the inverter is powered by solar panels rather than a battery. Note
that switches and settings obsolete for setups without any battery-powered
inverters are hidden.

#### Compensate For Shading :material-toggle-switch:{title="Switch"}

!!!note "For solar-powered inverters only"
    This option is only available for solar-powered inverters and is not
    included in the screenshot above.

!!!danger "Cabling limits"
    Do **NOT** enable this option if the AC cabling is potentially unable to
    safely handle the **rated** inverter output. The rated output is the
    inverter's AC power output while its limit is at 100% and all inputs
    deliver such that the inverter does output 100% of its rating, e.g., 2000W
    for an HMS-2000. The inverter output can surge over the **configured**
    maximum power limit if any input is no longer saturated at the expected
    power level, e.g., if the shading of a solar module is removed.

The calculated limit is usually sent to the inverter verbatim, and the inverter
will output the amount of power equivalent to the calculated limit, as it is
indeed able to draw the needed power from the battery. All inputs draw the same
amount of current.

Enable this option to scale the calculated limit such that the solar-powered
inverter is expected to output the calculated limit, despite significantly
different power being available on the inputs. This usually happens due to
shading of a subset of solar modules. This scaling means that the limit sent to
the inverter is actually higher than the calculated limit, but because some
inputs are saturated, the effective power output is equal to the calculated
limit.

#### Minimum Power Limit :material-form-textbox:{title="Textbox"}

In case the calculated limit for the inverter is smaller than this value, the
inverter is actually

* shut down if the inverter is battery-powered.
* set to this minimum power limit if the inverter is solar-powered.

!!!note "Stable operation"
    Small power limits can lead to oscillating power output and the inverter
    shutting down because of these oscillations. As a rule of thumb, the
    minimum limit should be greater or equal to the amount of inverter inputs
    times 12W.

#### Maximum Power Limit :material-form-textbox:{title="Textbox"}

The inverter limit is set such that its AC output does not exceed this value.

### Common Inverter Settings

#### Use Battery At Night Even If Only Partially Charged :material-toggle-switch:{title="Switch"}

The inverters may only draw power from the battery during a discharge cycle. A
discharge cycle starts when the respective start threshold is reached. When
enabling this option, a discharge cycle also starts roughly on sunset, even if
the battery charge cycle did not complete.

Enabling this option makes sense if you use a high value for the start
threshold, i.e., a value that translates to the battery being nearly full.
Doing so will prevent battery discharging during the day, but will also prevent
discharging during the night if the start threshold was not reached.

!!!note "Efficiency"
    With Solar-Passthrough disabled, it is more efficient to choose a low
    start threshold and to disable this option, such that produced energy is
    used immediately rather than stored in the battery first.

!!! note "Ending Nighttime Discharging"
    Discharging the battery always ends when reaching the stop threshold. If a
    discharge cycle was previously started because of this option being enabled,
    discharging also ends roughly at sunrise, even if the battery still stores
    a significant amount of energy.

#### Inverter Used For Voltage Measurement :material-form-dropdown:{title="Dropdown"}

The battery voltage is read from one input of the selected inverter if no other
source is available to read the battery voltage.

#### Input Used For Voltage Measurement :material-form-dropdown:{title="Dropdown"}

Define the input of the selected inverter that is used to read the battery
voltage.

#### Automatic Restart Time :material-form-dropdown:{title="Dropdown"}

!!!danger "Persistent Limit"
    Manually set a low **persistent** limit when using this feature.

The daily yield of any inverter is usually reset at night when the inverter
turns off due to lack of light. To reset the daily yield even though the
inverter is continuously powered by the battery, all governed battery-powered
inverters can be automatically restarted at the desired time.

After an inverter restarts, it starts producing power. How much power that is
depends on the value set as the persistent limit. Hence the persistent limit
for inverters managed by the DPL shall be very low if they are automatically
restarted. Otherwise, a possibly empty battery is drained with possibly high
power for some time. The DPL will eventually set a new limit or put the
inverter into standby after it restarted.

### Solar-Passthrough

#### Enable Solar-Passthrough :material-toggle-switch:{title="Switch"}

Enables or disables the [(Full) Solar-Passthrough](../solar_passthrough.md)
feature.

#### (Full) Solar-Passthrough Losses :material-form-textbox:{title="Textbox"}

Line losses are to be expected when transferring energy from the solar charge
controller(s) to the inverter(s). These losses can be taken into account to
prevent the battery from gradually discharging in (Full) Solar-Passthrough
mode. The power limits to be set on the inverters are additionally reduced by
this factor after taking the respective inverter's efficiency into account.

### Battery Thresholds

In general, State of Charge (SoC) thresholds take priority over voltage
thresholds, i.e., if the battery SoC is known (battery interface enabled, SoC
value valid and not outdated) it is used to determine whether or not a
particular threshold is reached.

#### Use Voltage Thresholds Only :material-toggle-switch:{title="Switch"}

Enable this switch to have the DPL use the voltage thresholds rather than the
SoC thresholds even though the battery SoC is available. As the SoC value is
hard to keep accurate, it is often a good option to start and stop discharging
based on the battery's voltage rather than the reported SoC.

#### Start Threshold for Battery Discharging :material-form-textbox:{title="Textbox"}

!!!note
    This threshold is "reached" if the battery SoC or voltage value is greater
    or equal to this threshold value.

Drawing power from the battery is allowed once the battery reaches this
threshold. When this threshold is reached, a discharge cycle begins.

There is no need for this value to be close to the voltage the battery has when
it is fully charged. Using a partially charged battery during the day, while it
is still charging, is acceptable.

#### Stop Threshold for Battery Discharging :material-form-textbox:{title="Textbox"}

!!!note
    This threshold is "reached" if the battery SoC or voltage value is smaller
    than this threshold value.

!!!warning "Avoid BMS intervention"
    When using the voltage stop threshold, it should be chosen such that the
    BMS has no need to interfere, i.e., such that the inverter stops
    discharging the battery long before the BMS disables discharging the battery
    to protect it due to an undervoltage condition.

Battery discharging is avoided once the battery reaches this threshold.
When this threshold is reached, a charge cycle begins.

This value must be smaller than the battery discharging start threshold.

#### Full Solar-Passthrough Start Threshold :material-form-textbox:{title="Textbox"}

!!!note
    This threshold is "reached" if the battery SoC or voltage value is greater
    or equal to this threshold value.

See the [Full Solar-Passthrough documentation](../solar_passthrough.md).

Set to 0% (SoC threshold) and 66V (voltage threshold) to effectively disable
**Full** Solar-Passthrough while keeping Solar-Passthrough. Otherwise this is
typically set to a value that indicates a (nearly) fully charged battery.

#### Full Solar-Passthrough Stop Threshold :material-form-textbox:{title="Textbox"}

!!!note
    This threshold is "reached" if the battery voltage value is smaller
    than this threshold value.

See the [Full Solar-Passthrough documentation](../solar_passthrough.md).

When starting Full Solar-Passthrough, the battery stops charging as all solar
power is used by the inverter to produce AC power. This causes the battery
voltage to drop slightly. Due to fluctuations in the solar power output, the
battery might be slightly discharged in Full Solar-Passthrough mode, causing
the battery voltage to drop further. For that reason, this threshold shall be
configured to a slightly smaller value than the Full Solar-Passthrough start
threshold, such that Full Solar-Passthrough is not started and stopped
repeatedly.

#### Load correction factor :material-form-textbox:{title="Textbox"}

!!!note "Applicable to voltage thresholds"
    This setting is only applicable if the DPL is using voltage thresholds.

When the battery is discharged, its voltage drops. Additionally, depending on
where the battery voltage is read, line losses can significantly influence the
voltage reading, especially at high currents. In both cases, the voltage drop
scales with the discharge current.

In order to not stop the inverter too early (stop threshold) while the battery
is being discharged, this load correction factor can be specified to calculate
(estimate) the battery voltage if it became idle. In other words: This value
should be chosen such that the battery settles back to around the stop
threshold voltage at the moment the DPL decides to stop discharging the battery
because it hit the stop threshold.

`corrected (idle) voltage = measured battery voltage + (power * correction factor)`

This value depends on your setup and requires tuning. Assuming a LFP battery
pack, perform the tuning procedure outside the non-linear voltage range, i.e.,
when the battery is neither full nor empty.

1. Disable all battery loads. This possibly means to disable the DPL.
2. Let the battery settle and note the idle voltage at the point where the DPL
   reads the voltage as well, i.e., the voltage reported by the BMS,
   by the charge controller, or by the inverter input,
   depending on your setup.
3. Enable a high load with a specific power. This typically means to set your
   inverter to the maximum allowable limit (using the web interface).
4. Observe the battery voltage drop and note this voltage (load voltage).
5. Disable the load after a couple of seconds.
6. The battery voltage should settle back (close) to the idle voltage noted
   earlier.
7. `correction factor = (idle voltage - load voltage) / specific power`
